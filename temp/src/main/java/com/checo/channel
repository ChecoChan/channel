import javax.xml.namespace.QName;
import javax.xml.stream.*;
import javax.xml.stream.events.*;
import java.io.InputStream;
import java.io.StringWriter;
import java.util.ArrayList;
import java.util.List;

/**
 * Pain.008 按单个 DrctDbtTxInf 交易拆分工具
 */
public class Pain008Splitter {

    /**
     * 将输入 Pain.008 文件按单个交易拆分
     *
     * @param in S3 InputStream
     * @return List，每个元素是完整 XML
     */
    public static List<String> splitPain008(InputStream in) throws XMLStreamException {
        List<String> result = new ArrayList<>();
        XMLInputFactory factory = XMLInputFactory.newInstance();
        XMLEventReader reader = factory.createXMLEventReader(in);

        String documentStart = null;
        String documentEnd = null;
        String cstmrStart = null;
        String cstmrEnd = null;
        String grpHdrXml = null;
        String pmtInfHeaderXml = null;
        EndElement pmtInfEndElement = null;

        while (reader.hasNext()) {
            XMLEvent e = reader.nextEvent();

            if (!e.isStartElement()) continue;

            String localName = e.asStartElement().getName().getLocalPart();

            switch (localName) {

                case "Document":
                    documentStart = writeSingleEvent(e);
                    documentEnd = findEndElement(reader, "Document").toString();
                    break;

                case "CstmrDrctDbtInitn":
                    cstmrStart = writeSingleEvent(e);
                    cstmrEnd = findEndElement(reader, "CstmrDrctDbtInitn").toString();
                    break;

                case "GrpHdr":
                    grpHdrXml = readExactElement(reader, e.asStartElement());
                    break;

                case "PmtInf":
                    PmtInfContext pmtInfCtx = readPmtInfHeader(reader, e.asStartElement());
                    pmtInfHeaderXml = pmtInfCtx.headerXml;
                    pmtInfEndElement = pmtInfCtx.pmtInfEndElement;
                    break;

                case "DrctDbtTxInf":
                    // 每个交易
                    String txXml = readExactElement(reader, e.asStartElement());

                    // 拼接完整 XML
                    String fullXml = documentStart +
                            cstmrStart +
                            grpHdrXml +
                            "<PmtInf>" + // 用 header 包裹交易
                            pmtInfHeaderXml +
                            txXml +
                            pmtInfEndElement.toString() +
                            cstmrEnd +
                            documentEnd;

                    result.add(fullXml);
                    break;
            }
        }

        reader.close();
        return result;
    }

    private static class PmtInfContext {
        final String headerXml;
        final EndElement pmtInfEndElement;

        PmtInfContext(String headerXml, EndElement pmtInfEndElement) {
            this.headerXml = headerXml;
            this.pmtInfEndElement = pmtInfEndElement;
        }
    }

    private static String writeSingleEvent(XMLEvent e) throws XMLStreamException {
        StringWriter sw = new StringWriter();
        XMLEventWriter writer = XMLOutputFactory.newInstance().createXMLEventWriter(sw);
        writer.add(e);
        writer.close();
        return sw.toString();
    }

    private static String readExactElement(XMLEventReader reader, StartElement start) throws XMLStreamException {
        String target = start.getName().getLocalPart();
        StringWriter sw = new StringWriter();
        XMLEventWriter writer = XMLOutputFactory.newInstance().createXMLEventWriter(sw);

        writer.add(start);
        int depth = 1;

        while (reader.hasNext() && depth > 0) {
            XMLEvent e = reader.nextEvent();
            writer.add(e);

            if (e.isStartElement() && target.equals(e.asStartElement().getName().getLocalPart())) {
                depth++;
            } else if (e.isEndElement() && target.equals(e.asEndElement().getName().getLocalPart())) {
                depth--;
            }
        }

        writer.close();
        return sw.toString();
    }

    private static PmtInfContext readPmtInfHeader(XMLEventReader reader, StartElement pmtInfStart) throws XMLStreamException {
        StringWriter sw = new StringWriter();
        XMLEventWriter writer = XMLOutputFactory.newInstance().createXMLEventWriter(sw);

        writer.add(pmtInfStart);

        while (reader.hasNext()) {
            XMLEvent next = reader.peek();

            if (next.isCharacters() && next.asCharacters().isWhiteSpace()) {
                writer.add(reader.nextEvent());
                continue;
            }

            if (next.isStartElement() && "DrctDbtTxInf".equals(next.asStartElement().getName().getLocalPart())) {
                break;
            }

            writer.add(reader.nextEvent());
        }

        // 不消费 PmtInf 尾部，在这里查找一次，供所有交易使用
        EndElement pmtInfEndElement = findEndElement(reader, "PmtInf");

        writer.close();
        return new PmtInfContext(sw.toString(), pmtInfEndElement);
    }

    private static EndElement findEndElement(XMLEventReader reader, String elementName) throws XMLStreamException {
        int depth = 0;
        while (reader.hasNext()) {
            XMLEvent e = reader.peek();

            if (e.isStartElement() && elementName.equals(e.asStartElement().getName().getLocalPart())) {
                depth++;
            }

            if (e.isEndElement() && elementName.equals(e.asEndElement().getName().getLocalPart())) {
                if (depth == 0) {
                    return e.asEndElement(); // 不消费，直接返回
                } else {
                    depth--;
                }
            }

            reader.nextEvent(); // 消费
        }
        throw new XMLStreamException("End element </" + elementName + "> not found");
    }
}