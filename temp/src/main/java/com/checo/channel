import javax.xml.stream.*;
import javax.xml.stream.events.*;
import java.io.InputStream;
import java.io.StringWriter;
import java.util.ArrayList;
import java.util.List;

public class Pain008Splitter {

    /**
     * 将输入的 Pain.008 文件按单个 DrctDbtTxInf 拆分成多个完整 XML
     */
    public static List<String> splitPain008(InputStream in) throws XMLStreamException {
        List<String> result = new ArrayList<>();
        XMLInputFactory factory = XMLInputFactory.newInstance();
        XMLEventReader reader = factory.createXMLEventReader(in);

        String documentStart = null;
        String cstmrStart = null;
        String grpHdrXml = null;
        String pmtInfHeaderXml = null;

        EndElement cstmrEndElement = null;
        EndElement documentEndElement = null;

        while (reader.hasNext()) {
            XMLEvent e = reader.nextEvent();

            if (!e.isStartElement()) continue;

            String localName = e.asStartElement().getName().getLocalPart();

            switch (localName) {

                case "Document":
                    documentStart = writeSingleEvent(e);
                    break;

                case "CstmrDrctDbtInitn":
                    cstmrStart = writeSingleEvent(e);
                    break;

                case "GrpHdr":
                    grpHdrXml = readExactElement(reader, e.asStartElement());
                    break;

                case "PmtInf":
                    // 读取 PmtInf header（直到第一个 DrctDbtTxInf）
                    pmtInfHeaderXml = readPmtInfHeader(reader, e.asStartElement());
                    break;

                case "DrctDbtTxInf":
                    // 读取当前交易
                    String txXml = readExactElement(reader, e.asStartElement());

                    // 拼接完整 XML
                    // 注意：尾部元素在此不消费，延后在整个流结束时处理
                    if (cstmrEndElement == null) {
                        cstmrEndElement = findEndElement(reader, "CstmrDrctDbtInitn");
                    }
                    if (documentEndElement == null) {
                        documentEndElement = findEndElement(reader, "Document");
                    }

                    String fullXml = documentStart +
                            cstmrStart +
                            grpHdrXml +
                            pmtInfHeaderXml +
                            txXml +
                            "</PmtInf>" + // 这里直接用结束标签的字符串形式
                            cstmrEndElement.toString() +
                            documentEndElement.toString();

                    result.add(fullXml);

                    // 下一个交易仍然使用同一个 header
                    break;
            }
        }

        reader.close();
        return result;
    }

    /**
     * PmtInf header 上下文（用于重复使用）
     */
    private static class PmtInfContext {
        final String headerXml;

        PmtInfContext(String headerXml) {
            this.headerXml = headerXml;
        }
    }

    /**
     * 写单个 start event 为字符串
     */
    private static String writeSingleEvent(XMLEvent e) throws XMLStreamException {
        StringWriter sw = new StringWriter();
        XMLEventWriter writer = XMLOutputFactory.newInstance().createXMLEventWriter(sw);
        writer.add(e);
        writer.close();
        return sw.toString();
    }

    /**
     * 精确读取完整元素（start 已消费）
     */
    private static String readExactElement(XMLEventReader reader, StartElement start) throws XMLStreamException {
        String target = start.getName().getLocalPart();
        StringWriter sw = new StringWriter();
        XMLEventWriter writer = XMLOutputFactory.newInstance().createXMLEventWriter(sw);

        writer.add(start);
        int depth = 1;

        while (reader.hasNext() && depth > 0) {
            XMLEvent e = reader.nextEvent();
            writer.add(e);

            if (e.isStartElement() && target.equals(e.asStartElement().getName().getLocalPart())) {
                depth++;
            } else if (e.isEndElement() && target.equals(e.asEndElement().getName().getLocalPart())) {
                depth--;
            }
        }

        writer.close();
        return sw.toString();
    }

    /**
     * 读取 PmtInf header（直到第一个 DrctDbtTxInf）
     */
    private static String readPmtInfHeader(XMLEventReader reader, StartElement pmtInfStart) throws XMLStreamException {
        StringWriter sw = new StringWriter();
        XMLEventWriter writer = XMLOutputFactory.newInstance().createXMLEventWriter(sw);

        writer.add(pmtInfStart);

        while (reader.hasNext()) {
            XMLEvent next = reader.peek();

            if (next.isCharacters() && next.asCharacters().isWhiteSpace()) {
                writer.add(reader.nextEvent());
                continue;
            }

            if (next.isStartElement() && "DrctDbtTxInf".equals(next.asStartElement().getName().getLocalPart())) {
                break;
            }

            writer.add(reader.nextEvent());
        }

        writer.close();
        return sw.toString();
    }

    /**
     * 找到指定 EndElement，不消费其他元素
     */
    private static EndElement findEndElement(XMLEventReader reader, String elementName) throws XMLStreamException {
        int depth = 0;
        while (reader.hasNext()) {
            XMLEvent e = reader.peek();

            if (e.isStartElement() && elementName.equals(e.asStartElement().getName().getLocalPart())) {
                depth++;
            }

            if (e.isEndElement() && elementName.equals(e.asEndElement().getName().getLocalPart())) {
                if (depth == 0) {
                    // 返回 EndElement，不消费
                    return e.asEndElement();
                } else {
                    depth--;
                }
            }

            reader.nextEvent(); // 消费事件
        }
        throw new XMLStreamException("End element </" + elementName + "> not found");
    }
}